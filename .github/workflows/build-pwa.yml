name: Build PWA Web App

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Expo CLI
      run: npm install -g @expo/cli@latest
      
    - name: Build for Web (PWA)
      run: |
        echo "Building Progressive Web App..."
        npx expo export --platform web --output-dir dist
        
        # Create PWA manifest
        cat > dist/manifest.json << 'EOF'
        {
          "name": "I-Track Mobile",
          "short_name": "I-Track",
          "description": "I-Track Vehicle Tracking Mobile App",
          "start_url": "/",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#000000",
          "orientation": "portrait",
          "icons": [
            {
              "src": "assets/logoitrack.png",
              "sizes": "192x192",
              "type": "image/png"
            },
            {
              "src": "assets/logoitrack.png", 
              "sizes": "512x512",
              "type": "image/png"
            }
          ]
        }
        EOF
        
        # Add PWA service worker
        cat > dist/sw.js << 'EOF'
        const CACHE_NAME = 'itrack-v1.0.0';
        const urlsToCache = [
          '/',
          '/static/js/bundle.js',
          '/static/css/main.css',
          '/assets/logoitrack.png'
        ];

        self.addEventListener('install', function(event) {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(function(cache) {
                return cache.addAll(urlsToCache);
              })
          );
        });

        self.addEventListener('fetch', function(event) {
          event.respondWith(
            caches.match(event.request)
              .then(function(response) {
                if (response) {
                  return response;
                }
                return fetch(event.request);
              }
            )
          );
        });
        EOF
        
        # Update index.html to include PWA features
        if [ -f "dist/index.html" ]; then
          sed -i 's|</head>|<link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000000"><script>if("serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js");}</script></head>|' dist/index.html
        fi
        
        echo "âœ… PWA build completed!"
        ls -la dist/
        
    - name: Create ZIP for distribution
      run: |
        cd dist
        zip -r ../I-Track-PWA.zip .
        cd ..
        ls -la I-Track-PWA.zip
        
    - name: Upload PWA artifact
      uses: actions/upload-artifact@v4
      with:
        name: I-Track-PWA-${{ github.sha }}
        path: I-Track-PWA.zip
        
    - name: Deploy to GitHub Pages (for instant access)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: pwa-v1.0.0-${{ github.run_number }}
        name: I-Track PWA v1.0.0-${{ github.run_number }}
        body: |
          ðŸ“± **I-Track Progressive Web App (PWA)**
          
          **ðŸš€ INSTANT ACCESS: Your app is now live!**
          
          **Access Methods:**
          1. **Live Web App**: https://vperalta-git.github.io/itrack/
          2. **Download ZIP**: Install locally or on web server
          3. **Install as App**: Use browser "Add to Home Screen" option
          
          **PWA Features:**
          - âœ… Works offline with cached data
          - âœ… Installable on mobile devices
          - âœ… Native app-like experience
          - âœ… Custom I-Track logo and branding
          - âœ… RENDER-FIRST backend connectivity
          - âœ… All original features preserved
          
          **Mobile Installation:**
          1. Open https://vperalta-git.github.io/itrack/ on your phone
          2. Tap browser menu â†’ "Add to Home Screen"
          3. App will install like a native app!
          
          **Backend Status:**
          - Production: https://itrack-backend-1.onrender.com âœ…
          - Database: MongoDB Atlas âœ…
          - Real-time functionality: Full support âœ…
          
        files: I-Track-PWA.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
